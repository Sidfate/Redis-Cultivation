# 高可用 - 哨兵

从库挂了或者断开了可以重连，如果主库挂了就影响到写操作处理了。

### 哨兵机制

哨兵三个任务：监控，选主和通知。

* 监控：哨兵周期性给主从库发送 PING 命令检查连接是否正常。

* 选主：主库挂了，根据规则选择一个从库做新的主库。

* 通知：通知其他从库新的主库的连接信息，还会通知客户端。

**怎么判断主库是异常的？**
如果主库本身连接正常只是暂时压力较大网络阻塞，哨兵检测的时候可能产生误判。哨兵可以通过集群模式部署的形式，减少误判发生的概率，即增加多个实例检测主库连接是否正常。

**怎么选出新的主库？**
先筛选后打分

筛选：
根据从库当前的网络状态以及之前的稳定性（断联次数）来过滤掉不合适的从库。

打分：
根据从库优先级、从库复制进度和从库ID依次打分，只要有一轮中产生最高分就选定。

从库复制进度可以通过从库的 slave_repl_offset 偏移量大小选择


选主的过程需要消耗一定的时间，这段时间内如果客户端发送写操作是会失败的，好的方式是客户端主动去通过哨兵获取主库地址进行写，这样客户端可以获取最新的实例地址。
