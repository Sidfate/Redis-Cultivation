# 数据持久化 - RDB

Redis 是一个数据存放在内存中，所以一旦服务器宕机，数据将会丢失。所以 Redis 需要需要实现数据的持久化，有两大机制，即 AOF 日志和 RDB 快照。

### RDB 快照

由于 AOF 日志记录的是命令，如果数据量过大，在宕机恢复的耗时较大。为了实现快速恢复，Redis 实现了内存快照，把某一时刻的内存数据以文件形式写到磁盘，即 RDB 文件。

快照带来的两个问题：
1. 数据的抉择，即对哪些数据做快照？
2. 快照生成过程中产生新的写操作怎么处理？


Redis 采用的是**全量快照**，提供了两个命令来生成 RDB 文件，分别是 save 和 bgsave。
* save：在主线程中执行，会导致阻塞；
* bgsave：创建一个子进程，专门用于写入 RDB 文件，避免了主线程的阻塞，这也是 Redis RDB 文件生成的默认配置。

Redis 借助操作系统的写时复制技术（Copy On Write），在执行快照的时候，正常处理写操作。

快照的频率需要兼顾考虑快照数据的完整性和写快照带来的性能消耗。因此 Redis 采用了混合 AOF 日志和内存快照的方式，在2次快照间使用 AOF 记录修改的数据，在做快照时将修改的数据以增量的形式写入 RDB 文件。

关于 AOF 和 RDB 的选择问题：
* 数据不能丢失时，内存快照和 AOF 的混合使用是一个很好的选择；
* 如果允许分钟级别的数据丢失，可以只使用 RDB；
* 如果只用 AOF，优先使用 everysec 的配置选项，因为它在可靠性和性能之间取了一个平衡。