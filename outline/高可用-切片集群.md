# 切片集群

当 Redis 数据量很大的时候，执行持久化的过程中需要有较大的的内存上限，不然很可能造成阻塞慢响应。Redis 的切片集群（Redis Cluster）通过横向扩展可以支撑大批量的数据，将数据分布到不同的 redis 实例上，减少单次持久化的消耗。

### 数据分布

Redis Cluster 方案采用哈希槽（Hash Slot，接下来我会直接称之为 Slot），来处理数据和实例之间的映射关系。在 Redis Cluster 方案中，一个切片集群共有 16384 个哈希槽，这些哈希槽类似于数据分区，每个键值对都会根据它的 key，被映射到一个哈希槽中。

1. 首先根据键值对的 key，按照CRC16 算法计算一个 16 bit 的值；
2. 然后，再用这个 16bit 值对 16384 取模，得到 0~16383 范围内的模数，每个模数代表一个相应编号的哈希槽。

### 数据获取

Redis 实例会把自己的哈希槽信息发给和它相连接的其它实例，来完成哈希槽分配信息的扩散。当实例之间相互连接后，每个实例就有所有哈希槽的映射关系了。客户端收到哈希槽信息后，会把哈希槽信息缓存在本地。当客户端请求键值对时，会先计算键所对应的哈希槽，然后就可以给相应的实例发送请求了。

由于集群中可能产生Redis实例的数量变化，还有为了负载均衡重新分配哈希槽，这时候客户端通过重定向机制实现访问：
1. 客户端访问某个数据，哈希槽对应原先的实例1
2. 实例1查不到数据，给客户端返回 MOVED 重定向命令，同时返回数据对应的新实例2
3. 客户端收到重定向命令后重新访问实例3，同时更新本地缓存

如果客户端访问的数据更在迁移的过程中，那么原先实例会先返回 ASK 命令以及数据存放的新实例地址，客户端需要给新实例发送 ASKING 命令，然后在发送操作命令。
ASK 命令不会让客户端更新缓存，因为槽正在重新分配。