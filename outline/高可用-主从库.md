# 高可用 - 主从模式

Redis 提供了主从库模式，使用了常见的读写分离：
* 主从库都可以读
* 写操作先在主库执行，后同步给从库

### 第一次同步

1. 主从库建立连接、协商同步的过程，为全量复制做准备。从库与主库建立连接，并通知主库即将进行同步，主库确认回复后，开始同步。
    从库发送psync命令给主库，附带2个参数：主库的runID（初始为?）和复制进度offset（初始为-1），主库收到psync命令后，会用 FULLRESYNC （全量复制）响应，再把之前的2个参数带上给从库。

2. 主库同步数据给从库，从库收到数据后，在本地完成数据加载（依赖RDB文件）。

3. 主库把第二阶段执行过程中新收到的新命令在发送给从库。命令记录在专门的 replication buffer 中。

![](https://sidfate.oss-cn-hangzhou.aliyuncs.com/uPic/86HiKo.jpg)

**主从联级**
生成和传输 RDB文件比较耗时，全放在主库上压力较大，因此联级模式（主-从-从）分担主库压力。即可以在集群中选择一部分从库作为其他从库的主库。

![](https://sidfate.oss-cn-hangzhou.aliyuncs.com/uPic/HqjB3L.jpg)

一旦主从库完成了全量复制，它们之间就会一直维护一个网络连接（长连接）。

### 断联策略

主从间的网络如果断开，可以通过增量复制的形式继续同步。

当主从库断连后，主库会把断连期间收到的写操作命令，写入 replication buffer，同时也会把这些操作命令也写入 repl_backlog_buffer 这个缓冲区。

repl_backlog_buffer 是一个环形缓冲区，主库写命令后对应的偏移量就是 master_repl_offset，从库在复制完写命令后对应的偏移量是 slave_repl_offset，一般来说这两个值相等。

当主从库断开后，从库发送 psync 命令，把自己的 slave_repl_offset 发送给主库，主库判断与自己 master_repl_offset 的差值，把中间的这些命令发送给从库。

因为 repl_backlog_buffer 是一个环形缓冲区，所以在缓存区写满后，主库还会继续写入，这就可能覆盖了之前的写命令，所以有可能产生从库数据不一致的情况。

我们可以调整 repl_backlog_size 这个参数。这个参数和所需的缓冲空间大小有关。缓冲空间的计算公式是：
```
缓冲空间大小 = 主库写入命令速度 * 操作大小 - 主从库间网络传输命令速度 * 操作大小。
```
在实际应用中，考虑到可能存在一些突发的请求压力，我们通常需要把这个缓冲空间扩大一倍，即 repl_backlog_size = 缓冲空间大小 * 2，这也就是 repl_backlog_size 的最终值。